<!DOCTYPE html>
<html>
  <head>
    <title>Garduino WebServer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="data:,">
    <script>
      function DisplayCurrentTime() {
          var date = new Date();
          var hours   = date.getHours()   < 10 ? "0" + date.getHours()   : date.getHours();
          var minutes = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
          var seconds = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
          time = hours + ":" + minutes + ":" + seconds;
          document.getElementById("currentTime").innerHTML = time;
      };

      function EventButtonClicked(element, element_idx) {
        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            ParseXML(this);
            DisplayCurrentTime();
          }
        }

        var requestString = "channel.xml?channel=" + element_idx + "&" + element.name + "=" + element.checked;
        request.open("GET", requestString, true);
        request.send(null);
      };

      function EventElementChanged(element, element_idx) {
        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            ParseXML(this);
            DisplayCurrentTime();
          }
        }

        var requestString = "channel.xml?channel=" + element_idx + "&" + element.name + "=" + element.value;
        request.open("GET", requestString, true);
        request.send(null);
      };

      function EventConfig(element) {
        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            DisplayCurrentTime();
          }
        }

        var requestString = "config.xml?action=" + element.id;
        request.open("GET", requestString, true);
        request.send(null);
      };

      function DrawTable(num_channel) {
        var table = "<tr><th>Id</th><th>Enabled</th><th>State</th><th>Time</th><th>Duration</th><th>Repeat</th><th>AdjustSetpoint</th><th>AdjustOffset</th><th>Skip</th></tr>";
        
        for (var i = 0; i < num_channel; i++) {
          var buttonEnabled = "<label class=\"switch\"><input id=\"enabled" + i + "\" name=\"enabled\" type=\"checkbox\" onclick=\"EventButtonClicked(this, " + i + ")\"><span class=\"slider round\"></span></label>"
          var buttonState   = "<label class=\"switch\"><input id=\"state"   + i + "\" name=\"state\"   type=\"checkbox\" onclick=\"EventButtonClicked(this, " + i + ")\"><span class=\"slider round\"></span></label>"
          var buttonSkip    = "<label class=\"switch\"><input id=\"skip"    + i + "\" name=\"skip\"    type=\"checkbox\" onclick=\"EventButtonClicked(this, " + i + ")\"><span class=\"slider round\"></span></label>"

          var optionNone    = "<option value=\"none\">None</option>"
          var optionSunrise = "<option value=\"sunrise\">Sunrise</option>"
          var optionNoon    = "<option value=\"noon\">Noon</option>"
          var optionSunset  = "<option value=\"sunset\">Sunset</option>"

          var comboSetpoint = "<select id=\"setpoint" + i + "\" name=\"setpoint\"                 onchange=\"EventElementChanged(this, " + i + ")\">" + optionNone + optionSunrise + optionNoon + optionSunset + "</select>";
          var editTime      = "<input id=\"time"      + i + "\" name=\"time\"     type=\"time\"   onchange=\"EventElementChanged(this, " + i + ")\">";
          var editDuration  = "<input id=\"duration"  + i + "\" name=\"duration\" type=\"number\" onchange=\"EventElementChanged(this, " + i + ")\">";
          var editRepeat    = "<input id=\"repeat"    + i + "\" name=\"repeat\"   type=\"number\" onchange=\"EventElementChanged(this, " + i + ")\">";
          var editOffset    = "<input id=\"offset"    + i + "\" name=\"offset\"   type=\"number\" onchange=\"EventElementChanged(this, " + i + ")\">";
          
          table += "<tr><td>" + i + "</td><td>" + buttonEnabled + "</td><td>" + buttonState + "</td><td>" + editTime + "</td><td>" +  editDuration + "</td><td>" + editRepeat + "</td><td>" + comboSetpoint + "</td><td>" + editOffset + "</td><td>" + buttonSkip + "</td></tr>";
        }
        document.getElementById("channels").innerHTML = table;
      };

      function ParseXML(xml) {
        var responseChannel = xml.responseXML.getElementsByTagName("channel");

        for (var i = 0; i < responseChannel.length; i++) {
          var idx = responseChannel[i].getAttribute('id');

          var responseEnabled  = responseChannel[i].getElementsByTagName("enabled")[0].childNodes[0].nodeValue;
          var responseState    = responseChannel[i].getElementsByTagName("state")[0].childNodes[0].nodeValue;
          var responseTime     = responseChannel[i].getElementsByTagName("time")[0].childNodes[0].nodeValue;
          var responseDuration = responseChannel[i].getElementsByTagName("duration")[0].childNodes[0].nodeValue;
          var responseRepeat   = responseChannel[i].getElementsByTagName("repeat")[0].childNodes[0].nodeValue;
          var responseOffset   = responseChannel[i].getElementsByTagName("offset")[0].childNodes[0].nodeValue;
          var responseSetpoint = responseChannel[i].getElementsByTagName("setpoint")[0].childNodes[0].nodeValue;


          document.getElementById("time"     + idx).value = responseTime;
          document.getElementById("duration" + idx).value = responseDuration;
          document.getElementById("repeat"   + idx).value = responseRepeat;
          document.getElementById("offset"   + idx).value = responseOffset;
          document.getElementById("setpoint" + idx).value = responseSetpoint;
      
          
          if (responseEnabled == "true") {
            document.getElementById("enabled" + idx).checked = true;
          }
          else if (responseEnabled == "false"){
            document.getElementById("enabled" + idx).checked = false;
          }

          if (responseState == "skip") {
            document.getElementById("state" + idx).checked = false;
            document.getElementById("skip"  + idx).checked = true;
          }
          else if (responseState == "active") {
            document.getElementById("state" + idx).checked = true;
            document.getElementById("skip"  + idx).checked = false;
          }
          else {
            document.getElementById("state" + idx).checked = false;
            document.getElementById("skip"  + idx).checked = false;
          }
        }
      }

      function RequestXML() {
        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            DrawTable(this.responseXML.getElementsByTagName("channel").length)
            ParseXML(this);
            DisplayCurrentTime();
          }
        }
        request.open("GET", "channel.xml", true);
        request.send(null);
      };
      
      document.addEventListener('DOMContentLoaded', function() {
        RequestXML();
        setInterval('RequestXML()', 10000);
        //setInterval('DisplayCurrentTime()', 1000);
      }, false);
    </script>
    <style>
      body {
        text-align: center;
        font-family: "Trebuchet MS", Arial;
      }
      table {
        border-collapse: collapse;
        width:60%;
        margin-left:auto;
        margin-right:auto;
      }
      th {
        padding: 16px;
        background-color: #2196F3;
        color: white;
      }
      tr {
        border: 1px solid #ddd;
        padding: 16px;
      }
      tr:hover {
        background-color: #bcbcbc;
      }
      td {
        border: none;
        padding: 16px;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 25px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: .4s;
        transition: .4s;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 19px;
        width: 19px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        -webkit-transition: .4s;
        transition: .4s;
      }
      input:checked + .slider {
        background-color: #2196F3;
      }
      input:focus + .slider {
        box-shadow: 0 0 1px #2196F3;
      }
      input:checked + .slider:before {
        -webkit-transform: translateX(25px);
        -ms-transform: translateX(25px);
        transform: translateX(25px);
      }
      .slider.round {
        border-radius: 25px;
      }
      .slider.round:before {
        border-radius: 50%;
      }
      .button {
        border: none;
        color: white;
        padding: 16px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        transition-duration: 0.2s;
        cursor: pointer;
        background-color: white; 
        color: black; 
        border: 2px solid #2196F3;
      }
      .button:hover {
        background-color: #2196F3;
        color: white;
      }

</style>
</head>
    </style>
  </head>
  <body>
      <h1>Garduino</h1>
      <h2><span id="currentTime"></span></h2>
      <button class="button" id="save" name="buttonSave" onclick="EventConfig(this)">Save Config to EEPROM</button>
      <button class="button" id="load" name="buttonLoad" onclick="EventConfig(this)">Load Config from EEPROM</button>
      <table id="channels"><tr><th>Id</th><th>Enabled</th><th>State</th><th>Time</th><th>Duration</th><th>Repeat</th><th>AdjustSetpoint</th><th>AdjustOffset</th><th>Skip</th></tr>
      <br><br>
  </body>
</html>
